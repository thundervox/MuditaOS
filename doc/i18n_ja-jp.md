# 国際化

## ファイルとデータ構造

### 表示言語

現在の実装において、 MuditaOS インタフェースで使われている言語表現は [image/system_a/data/lang フォルダ](../image/system_a/data/lang/)にある JSON 形式のファイルとしてまとめてあります。

現在の実装において、起動時に該当する言語がない場合に使われるデフォルトのフォールバック用ファイルは英語版 (`English.json`) です。

MuditaOS は言語ファイル名 (拡張子は除く) から使用言語名を得て表示します。そのため言語ファイルの命名規則は万国共通の英語表記にしてください。例えば、 `Deutsch.json` は言語設定では `Deutsch` と表示されます。

言語ファイルの名前とそのファイルの内容に関しても作成時に一致させる必要があります。例えば、英語ならば `English.json` を、ポーランド語ならば `Polski.json` を、そして日本語ならば `Japanese.json` などのようになります。

このファイルの構造は一般的な JSON 形式のファイルです。
```c++
(...)
"common_open": "OPEN",
"common_call": "CALL",
"common_save": "SAVE",
"common_send": "SEND",
(...)
```

左辺側のキーは右辺側の値を参照します。この値の設定後は MuditaOS アプリケーションで表示に使われます。

### キーボードの入力言語

キーボード入力言語ファイルとは [image/system_a/data/profiles フォルダ](../)にある拡張子 JSON のファイルのことです。

言語ごとに独立した大文字と小文字のファイルがあります。この用例は `English_lower.json` における JSON 形式のファイルです。

```c++
{
  "filetype": "normal",
  "31": ".,_:;)(?!#/*+",
  "32": "abc",
  "33": "def",
  "41": "ghi",
  "42": "jkl",
  "43": "mno",
  "51": "pqrs",
  "52": "tuv",
  "53": "wxyz",
  "61": "0x0A",
  "62": " ",
  "63": "0x08"
}
```
このファイルの種類を最初の値である `filetype` で宣言します。
- `normal` - 入力言語の設定に表示します。ユーザは GUI から入力言語を変更できます (例えば、英語からポーランド語へ切り替え)。
- `special` -  入力言語の設定に表示しません。文字コードの変更のみ行います (例えば、テンキー)。

Normal 方式のファイルは設定画面で言語ファイル名を表示します (例えば、 `English_lower.json` と `English_upper.json` の表示は `English` となります)。
入力言語の新規追加時は言語の大文字と小文字を定義したファイルを必ず作成する必要があります。

以下のキーと値のペアにはキーコード (キー) とこのキーで扱える文字 (値) があります。なお、十六進数表記のボタンは二種類 (`61` と `63` のボタン) あります。以下の値により MuditaOS の処理を指定します。

- `0x0A` - ボタンの短押し (解説は後述) 後に入力モードを変更(小文字から大文字へ、大文字から小文字へ)します。 長押し後に特殊文字入力ウィンドウを表示します。 
- `0x08` - ボタンの短押し後に文字を削除します。

ファイルの命名規則は次の通りにしてください。例えば、ローディアン語の入力言語に関する正しい実装は `Rodian_lower.json` と `Rodian_upper.json` のファイルで構成してください。

また、ボタンの押しかたとして短押しと長押しを使い分けます。
- `shortpress` - ロードした入力言語ファイルの定義に従い文字入力をするために使います。
- `longpress` - この方式のボタンの押しかたはユーザがボタンを最低 2 秒間長押し後に離す使いかたをします。テキストの入力では数値入力で使います。

用例: キーボードの言語として英語を使用時に小文字入力モードで `1` ボタン (キーコードの `31`) を押して即座に離すと、 SMS のテキスト入力欄には`a` を表示します。また、このボタンを最低 2 秒間長押し後に離すと、数字の `1` を表示します。

Mudita Pure で使用しているキーコードに関する定義は [key_codes.hpp ファイル (KeyCodes 列挙型)](../module-bsp/bsp/keyboard/key_codes.hpp) に記載してあります。

### 日付と時刻

MuditaOS は [Linux の `date`](https://man7.org/linux/man-pages/man1/date.1.html) コマンドの日時形式を採用しています。

## フォントの変換

MuditaOS には TrueType (.ttf) / OpenType (.otf) フォントのサポートが実装されていません。そのため、フォントを使うにはフォント用のビットマップファイルを生成します。公式リリース版 (Proprietary) では正規ライセンス品の GT Pressura Typeface ([詳細情報](../LICENSE.md)) を使用しています。

MuditaOS は以下の言語 (および文字) に標準サポートしています。

- 英語
- ドイツ語
- スペイン語
- ポーランド語
- フランス語

上記以外の言語では言語固有グリフの追加、[fontbuilder](https://github.com/mudita/fontbuilder) でのビルドとリポジトリへの登録が必要になる場合があります。

[こちらは GT Pressura でサポートしているグリフのリストです](https://www.grillitype.com/api/storage/app/uploads/public/5b6/c52/16b/5b6c5216b40a8675629257.pdf) (現在のライセンス契約の制約によりラテン語のアルファベットのみ収録しています)。

[こちらは現在のビルドで追加された文字のリストです
](https://github.com/mudita/fontbuilder/blob/master/charset.txt)。

現在の実装ではメインフォント、あるいはフォールバック用のフォント (DeJavu Sans Bold) でサポートされていない文字があります。 なお、 MuditaOS ではユーザが用意したフォントを利用することで実現可能な多言語対応 UI のレンダリング機能の開発に取り組んでいます。ご理解とご協力をお願いします。

### グリフの追加

追加作業には [fontbuilder](https://github.com/mudita/fontbuilder)
を使います。これでフォントセットはファイルへ保存されますが、システムプリセットの保存に適した良いソリューションとは言えません (これはリリース段階で行うものです)。この作業の方法は、

- プリセットファイルを用いて FontBuilder を UI 無表示状態で実行することで MPF (Mudita Pure Font) 形式によるフォントファイルのビルドをします。
- 変換後のフォントはビルドフォルダに配置します。

Mudita Pure phone で使用しているフォントは、

- デフォルトフォント (`gt_pressura` フォントファミリー)
- デフォルトのフォールバック用フォント (DeJavu Sans Bold サイズ 27 ポイント **絵文字のみ**)

`▯` グリフは現在のフォントに Uincode 文字として該当するグリフがないことを意味します。

#### 名前規約

フォント名を変更せずそのままにしておくのは良いことです。この名前はフォントのメタデータとして存在しています、また、メタデータはコードで使われるものです (フォントのファイル名ではない)。この名前は無変更のままにしてください。

#### ファイルの所在

- ビルド時に使われるフォントファイルの所在は、 `PurePhone/image/assets/fonts/`
- 起動中に使うフォントファイル (ビルド時にコピー) の所在は、 `PurePhone/<ビルドフォルダ>/assets/fonts/`

## インタフェースのローカライズ作業を始めるには

1. 作業対象のローカライズに関する issue (課題) を作成します。タイトルには `[英語表記の言語名] localization [絵文字表記の国旗]` の命名規則を使用してください。例えば、日本語でしたら `Japanese localization 🇯🇵` と記入します。絵文字表記の国旗を使う理由はコミュニティの参加者が興味のあるローカライズの成果を見つけやすくしたりローカライズに関する実装の開発支援をしやすくする上で有益なちょっとした心遣いになります。なお、ローカライズ作業に参加したい場合は、そのローカライズが第三者によって実装済みでないことをご確認ください。
2. GitHub では新規 issue に `i18n` ラベルを追加してください。
3. [MuditaOS の開発協力に関する解説記事](../CONTRIBUTING.md) に従って作業を進めます。
4. ローカライズ作業完了後にプルリクエストを作成してください。確認次第レビューを行い MuditaOS の公式ディストリビューションへ追加させていただきます。
