# 製品について

このソースツリーには以下の製品がまとめられています。丸括弧は製品の略称です。

* PurePhone ( Pure )
* BellHybrid ( Bell )

便宜上、イメージの作成とパッケージの更新用の CMake ターゲットも定義してあります。

# アーキテクチャ

サポートしているターゲットのアーキテクチャは、

* Linux x86_64
* RT1051

選択したターゲットのアーキテクチャにより一部のビルドターゲットにおいてが有効・無効になります。

# ターゲット

各種製品には以下のターゲットがあります。

| アーキテクチャ   | 名前                        | エイリアス                                           | 概要                                                                   |
|--------|-----------------------------|-------------------------------------------------|-------------------------------------------------------------------------------|
| common | doc                         |                                                 | Doxygen ドキュメンテーションのビルドを行うターゲット。参照: [ドキュメンテーション](generate_doxygen.md)   |
| common | \<製品名\>                 |                                                 | 製品用のバイナリターゲット                                                 |
| common | \<製品名\>-disk-img        | \<製品名\>.img                                 | 製品用のディスクイメージ                                                    |
| RT1051 | \<製品名\>-StandaloneImage | PurePhone-\<バージョン\>-RT1051-package-standalone | `dd` または `pureflash` でデバイスに書き込めるイメージを作成します。                   |
| RT1051 | \<製品名>\-UpdatePackage   | PurePhone-\<バージョン\>-RT1051-Update.tar         | 更新パッケージを作成します。このパッケージは Mudita Center あるいは更新用のスクリプトで使えます。 |
| linux  | check                       |                                                 | ユニットテストのビルドと実行                                                       |
| common | json-common-target          |                                                 | Mudita 社製の商用版・コミュニティ版ビルド共用の一般公開用アセット  |
| common | json-community-target       |                                                 | Mudita 社製のコミュニティ版ビルド向け一般公開用アセット                              |
| common | json-proprietary-target     |                                                 | Mudita 社製の商用版ビルド向け社内用アセット                               |
| RT1051 | json-rt1051-assets          |                                                 | Mudita 社製 RT1051 版向け専用アセット                                         |
| RT1051 | ecoboot.bin-target          |                                                 | OS のブートローダー                                                                 |
| RT1051 | recovery.bin-target         |                                                 | OS のリカバリユーティリティ                                                           |

## 製品版バイナリのターゲット

以下の方法でソフトウェアのバイナリをロードします。
- J-Link
- デバイスへの書き込みは、
    - 更新用ユーティリティ
    - ダイレクトメモリアクセス

デバイスの記憶領域にはセキュリティキーが存在するため、バイナリの署名に関する追加作業が必要です。署名がない場合、起動時にデバイスは警告を表示します。

## ディスクイメージ

ソフトウェアのイメージデータはデバイスのメモリへロードされます。ディスクイメージには OS の正常動作に必要なデータが記録されています。ディスクイメージは開発用の外部アセットでビルド可能です。詳しい作成方法に関する情報は `WITH_DEVELOPMENT_FEATURES` を参照してください。

以下の手順により、**ディスイメージ全体の検証作業**ができます。
1. 作成後のイメージに `losetup` でループデバイスを追加します。例えば、
```
sudo losetup --show --partscan -f /path/to/file
```
2. 検証作業を行う必要のあるパーティションをマウントします。
3. 使用後はループデバイスの削除をお忘れなく (ここでは loopN がループデバイスとして作成してあります)
```
sudo losetup -d /dev/loopN
```

また、この作業は `tools/mount_user_lfs_partition.py` を使うことでもできます。

## パッケージの更新

tar 形式のファイルは更新用ユーティリティでソフトウェアの更新を行うために使われるものです。このファイルには更新に必要なアセットとメタデータが収録されています。
現在、更新用パッケージにはデバイスに存在する基本データがすべて存在します。更新用のデータを小型化するために、更新用パッケージの内容を必要最低限のものにしたり、 gzip で圧縮したパッケージを用意することも簡単にできるでしょう。


## 検査作業

選択した製品のリポジトリでユニットテストのビルドと実行を行います。
ユニットテストで必要となるアセット (フォント) は [download_assets](download_assets.md) でダウンロードします。

### コードカバレッジ

ユニットテストにおけるコードカバレッジのレポートを生成するには、プロジェクトの構成を `COVERAGE_ENABLE=ON` にします。注意点として、コードカバレッジのレポート生成機能は Linux/Debug 構成時のみ動作します。コードカバレッジのレポートは `gcovr` で生成します。インストール方法は、

```
pip3 install gcovr
```

以下のターゲットはカバレッジ関連のレポート生成として利用できるものです。

* `coverage-all-html` - `ctest` の実行後に詳細を記した HTML 形式のレポートを生成します。
* `coverage-html` - 最後に実行したユニットテストの収集データから詳細を記した HTML 形式のレポートを生成します。このレポートはビルドディレクトリに作成されるサブディレクトリである `coverage-html` に出力します。
* `coverage` - 上述と同じですが、 HTML 形式ではなく XML Cobertura 形式のレポートを生成します。

## json-common-target

Mudita 社製の一般公開アセットは [download_assets](./download_assets.md) でダウンロードします。このアセットは商用製品版とコミュニティ版で共用でありビルドにて使用します。

## json-community-target

Mudita 社製の一般公開アセットは [download_assets](./download_assets.md) でダウンロードします。このアセットはコミュニティ版のビルドのみで使用します。

## json-proprietary-target

Mudita 社内用アセットを [download_assets](./download_assets.md) によりダウンロードします。このアセットは社内の開発関係者以外は利用できず一般には非公開です。これは商用製品版のビルドで使います。この非公開アセット (フォントなど) は各種製品向けにディスクイメージやターゲットの更新パッケージとしてエンドユーザーが取り出せない形式で配布されています。

## json-rt1051-target

Mudita 社内用 RT1051 専用アセットを [download_assets](./download_assets.md) によりダウンロードします。このアセットは社内の開発関係者以外は利用できず一般には非公開です。
この非公開アセットは各種製品向けにディスクイメージやターゲットの更新パッケージとしてエンドユーザーが取り出せない形式で配布されています。

## ecoboot.bin-target

 [download_assets](download_assets.md) でブートローダーをダウンロードします。

OS のブートローダーは、ハードウェアの起動前の初期化、および OS またはリカバリユーティリティの起動で使われています。

## recovery.bin-target

更新プログラムは [download_assets](download_assets.md) でダウンロードします。

PureRecovery はシステムの更新処理、バックアップ、レストアなど各種作業を行うための補助アプリケーションです。
